<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>AR.js Waypoints Navigation</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>
  <style>
    .error-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 9999;
      text-align: center;
    }
    .loading-indicator {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 9999;
    }
  </style>
  <script>
    AFRAME.registerComponent('waypoints-manager', {
      init: function () {
        this.showLoadingIndicator();
        this.checkPermissions()
          .then(() => this.loadWaypoints())
          .catch(error => this.showError(error));
      },

      checkPermissions: function() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject('GPS not supported by your browser');
            return;
          }

          // Check GPS
          navigator.geolocation.getCurrentPosition(
            () => {
              // Check camera
              navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                  stream.getTracks().forEach(track => track.stop());
                  resolve();
                })
                .catch(() => reject('Camera access denied'));
            },
            () => reject('GPS access denied')
          );
        });
      },

      showLoadingIndicator: function() {
        const loading = document.createElement('div');
        loading.className = 'loading-indicator';
        loading.textContent = 'Loading waypoints...';
        document.body.appendChild(loading);
        this.loadingIndicator = loading;
      },

      hideLoadingIndicator: function() {
        if (this.loadingIndicator) {
          this.loadingIndicator.remove();
        }
      },

      showError: function(message) {
        const error = document.createElement('div');
        error.className = 'error-message';
        error.textContent = message;
        document.body.appendChild(error);
      },

      getRouteId: function () {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('routeId');
      },

      loadWaypoints: function () {
        const routeId = this.getRouteId();
        if (!routeId) {
          this.hideLoadingIndicator();
          this.showError('No routeId provided in URL');
          return;
        }

        const waypointsUrl = `https://waypoints-prht.onrender.com/get-waypoints/${routeId}`;
        fetch(waypointsUrl)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(waypoints => {
            console.log('Fetched waypoints:', waypoints);
            if (waypoints.length === 0) {
              this.showError('No waypoints found for this route');
              return;
            }

            waypoints.forEach((waypoint, index) => {
              if (!waypoint.lat || !waypoint.lng) {
                console.error(`Invalid coordinates for waypoint ${index + 1}`);
                return;
              }

              // Create container entity for better positioning
              const container = document.createElement('a-entity');
              container.setAttribute('gps-new-entity-place', {
                latitude: waypoint.lat,
                longitude: waypoint.lng
              });

              // Add box
              const box = document.createElement('a-box');
              box.setAttribute('color', this.getColorForIndex(index));
              box.setAttribute('scale', '0.5 0.5 0.5');  // Smaller scale
              box.setAttribute('position', '0 1 0');  // Raise slightly above ground
              
              // Add text label
              const text = document.createElement('a-text');
              text.setAttribute('value', `Waypoint ${index + 1}`);
              text.setAttribute('scale', '1 1 1');
              text.setAttribute('position', '0 1.5 0');  // Position above box
              text.setAttribute('align', 'center');
              text.setAttribute('color', 'white');
              
              container.appendChild(box);
              container.appendChild(text);
              this.el.sceneEl.appendChild(container);
              
              console.log(`Added waypoint ${index + 1}: lat ${waypoint.lat}, lon ${waypoint.lng}`);
            });

            this.hideLoadingIndicator();
          })
          .catch(error => {
            console.error('Error fetching waypoints:', error);
            this.hideLoadingIndicator();
            this.showError('Failed to load waypoints. Please try again.');
          });
      },

      getColorForIndex: function (index) {
        const colors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange'];
        return colors[index % colors.length];
      }
    });
  </script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; sourceWidth: 1280; sourceHeight: 960; displayWidth: 1280; displayHeight: 960;"
    waypoints-manager
  >
    <a-camera gps-new-camera="gpsMinDistance: 5; positionMinAccuracy: 10"></a-camera>
  </a-scene>
</body>
</html>
