<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Navigation</title>
    <style>
        /* Styles */
        .instruction-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }
        .permission-button {
            margin: 10px;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .permission-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #info {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
        #error-message {
            color: red;
            font-size: 14px;
            margin-top: 10px;
        }
        #permission-screen {
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="ar-canvas"></canvas>
    <div id="info" class="ui-overlay"></div>
    <div id="error-message"></div>

    <div id="permission-screen" class="instruction-overlay">
        <h2>AR Navigation Setup</h2>
        <p>This app requires:</p>
        <ul style="text-align: left;">
            <li>Camera access for AR</li>
            <li>Location access for navigation</li>
        </ul>
        <button id="permission-button" class="permission-button">Grant Permissions</button>
    </div>

    <button id="start-button" style="display: none;">Start AR Navigation</button>
    <button id="fallback-mode" style="display: none;">Use Non-AR Mode</button>

    <script async src="https://unpkg.com/es-module-shims@1.7.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.151.3/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.151.3/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // Variables
        let session = null;
        let localReferenceSpace = null;
        let viewerSpace = null;
        let gl = null;
        let renderer = null;
        let scene = null;
        let camera = null;
        let currentLocation = null;
        let waypoints = [];
        let waypointMarkers = [];
        
        const urlParams = new URLSearchParams(window.location.search);
        const routeId = urlParams.get('routeId');

        // Functions for showing messages
        function showMessage(message) {
            const info = document.getElementById('info');
            info.textContent = message;
            info.style.display = 'block';
            setTimeout(() => {
                info.style.display = 'none';
            }, 3000);
        }

        function showError(errorMessage) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = errorMessage;
            errorDiv.style.display = 'block';
        }

        function initFallbackMode() {
            showMessage('Fallback mode activated. AR features are disabled.');
            // Implement fallback logic (e.g., basic navigation without AR)
        }

        // Permission handling
        async function requestPermissions() {
            try {
                // Request camera permission
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop()); // Stop the stream after permission

                // Request location permission
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    });
                });

                // Hide permission screen and show start button
                document.getElementById('permission-screen').style.display = 'none';
                document.getElementById('start-button').style.display = 'block';
                showMessage('Permissions granted. Click Start to begin.');

            } catch (error) {
                console.error('Permission error:', error);
                showError('Required permissions were not granted. Please try again.');
                document.getElementById('permission-button').disabled = false;
            }
        }

async function startAR() {
    try {
        showMessage('Initializing AR...');
        
        const sessionInit = {
            requiredFeatures: ['local'],
            optionalFeatures: ['camera-access', 'dom-overlay'],
            domOverlay: { root: document.body }
        };

        session = await navigator.xr.requestSession('immersive-ar', sessionInit);

        const canvas = document.querySelector('#ar-canvas');
        gl = canvas.getContext('webgl2', { xrCompatible: true }) || 
             canvas.getContext('webgl', { xrCompatible: true });

        if (!gl) {
            showError('WebGL not supported on this device.');
            return;
        }

        renderer = new THREE.WebGLRenderer({
            canvas: canvas,
            context: gl,
            alpha: true,
            antialias: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 1000);
        scene.add(camera);

        // Add debugging visuals
        const axesHelper = new THREE.AxesHelper(1);
        scene.add(axesHelper);

        localReferenceSpace = await session.requestReferenceSpace('local');

        session.updateRenderState({
            baseLayer: new XRWebGLLayer(session, gl)
        });

        // Fetch waypoints if routeId exists
        if (routeId) {
            await fetchWaypoints(routeId);
        }

        session.requestAnimationFrame(onXRFrame);
        showMessage('AR Navigation Started');
    } catch (error) {
        console.error('AR initialization failed:', error);
        showError(`AR initialization failed: ${error.message}`);
        document.getElementById('fallback-mode').style.display = 'block';
    }
}


        // Frame rendering
        function onXRFrame(time, frame) {
            session.requestAnimationFrame(onXRFrame);

            const pose = frame.getViewerPose(localReferenceSpace);
            if (pose) {
                renderer.render(scene, camera);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('permission-screen').style.display = 'block';
            
            document.getElementById('permission-button').addEventListener('click', async (event) => {
                event.target.disabled = true;
                await requestPermissions();
            });

            document.getElementById('start-button').addEventListener('click', startAR);
            document.getElementById('fallback-mode').addEventListener('click', initFallbackMode);
        });
    </script>
</body>
</html>
