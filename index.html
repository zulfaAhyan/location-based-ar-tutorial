<!DOCTYPE html>
<html>
<!-- Previous head and style sections remain the same -->
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Navigation</title>
    <style>
        /* Previous styles remain the same */
        .instruction-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }
        .permission-button {
            margin: 10px;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .permission-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #permission-screen {
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="ar-canvas"></canvas>
    <div id="info" class="ui-overlay">
        Welcome to AR Navigation
    </div>
    
    <div id="permission-screen" class="instruction-overlay">
        <h2>AR Navigation Setup</h2>
        <p>This app requires:</p>
        <ul style="text-align: left;">
            <li>Camera access for AR</li>
            <li>Location access for navigation</li>
        </ul>
        <button id="permission-button" class="permission-button">Grant Permissions</button>
    </div>

    <button id="start-button" style="display: none;">Start AR Navigation</button>
    <button id="fallback-mode" style="display: none;">Use Non-AR Mode</button>
    <div id="error-message"></div>

    <script async src="https://unpkg.com/es-module-shims@1.7.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.151.3/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.151.3/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // Previous variable declarations remain the same
        let session = null;
        let localReferenceSpace = null;
        let viewerSpace = null;
        let gl = null;
        let renderer = null;
        let scene = null;
        let camera = null;
        let currentLocation = null;
        let waypoints = [];
        let waypointMarkers = [];
        
        const urlParams = new URLSearchParams(window.location.search);
        const routeId = urlParams.get('routeId');

        // Previous helper functions remain the same (createWaypointMarker, updateWaypointPositions, etc.)

        // New permission handling
        async function requestPermissions() {
            try {
                // Request camera permission
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop()); // Stop the stream after permission

                // Request location permission
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    });
                });

                // Hide permission screen and show start button
                document.getElementById('permission-screen').style.display = 'none';
                document.getElementById('start-button').style.display = 'block';
                showMessage('Permissions granted. Click Start to begin.');

            } catch (error) {
                console.error('Permission error:', error);
                showError('Required permissions were not granted. Please try again.');
                document.getElementById('permission-button').disabled = false;
            }
        }

        // Modified startAR function
        async function startAR() {
            try {
                showMessage('Initializing AR...');
                const arSupport = await checkARSupport();
                
                // Configure session with supported features
                const sessionInit = {
                    requiredFeatures: ['local'],
                    optionalFeatures: ['camera-access', 'dom-overlay'],
                    domOverlay: { root: document.body }
                };

                // Request the AR session within the click handler
                session = await navigator.xr.requestSession('immersive-ar', sessionInit);

                // Initialize WebGL context
                const canvas = document.querySelector('#ar-canvas');
                gl = canvas.getContext('webgl2', { xrCompatible: true }) ||
                     canvas.getContext('webgl', { xrCompatible: true });

                if (!gl) {
                    throw new Error('WebGL not supported');
                }

                // Set up renderer
                renderer = new THREE.WebGLRenderer({
                    canvas: canvas,
                    context: gl,
                    alpha: true,
                    antialias: true
                });
                
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.xr.enabled = true;

                initScene();

                // Set up reference spaces
                localReferenceSpace = await session.requestReferenceSpace('local');
                viewerSpace = await session.requestReferenceSpace('viewer');

                session.updateRenderState({
                    baseLayer: new XRWebGLLayer(session, gl)
                });

                // Start the XR animation loop
                session.requestAnimationFrame(onXRFrame);
                
                // Load waypoints and start tracking
                await Promise.all([
                    loadWaypoints(),
                    startLocationTracking()
                ]);

                showMessage('AR Navigation Started');
                
            } catch (error) {
                console.error('AR initialization failed:', error);
                showError(`AR initialization failed: ${error.message}`);
                document.getElementById('fallback-mode').style.display = 'block';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Show permission screen first
            document.getElementById('permission-screen').style.display = 'block';
            
            // Set up event listeners
            document.getElementById('permission-button').addEventListener('click', async (event) => {
                event.target.disabled = true;
                await requestPermissions();
            });

            document.getElementById('start-button').addEventListener('click', startAR);
            document.getElementById('fallback-mode').addEventListener('click', initFallbackMode);
        });

        // Previous helper functions remain the same
    </script>
</body>
</html>
