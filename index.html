<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR GPS Location</title>
    <script>
        // Compatibility fix
        window.PlaneBufferGeometry = window.PlaneGeometry = function PlaneBufferGeometry(width, height, widthSegments, heightSegments) {
            return new THREE.PlaneGeometry(width, height, widthSegments, heightSegments);
        };
    </script>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="antialias: true; alpha: true"
        embedded>
        <a-box
            color="red"
            scale="20 20 20"
            gps-entity-place="latitude: -6.761643; longitude: 39.193781;"
            look-at="[gps-camera]">
        </a-box>
        <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <div id="debugDiv" style="position: fixed; top: 0; left: 0; background: rgba(0,0,0,0.7); color: white; padding: 10px; font-family: monospace; font-size: 14px; z-index: 9999;">
        Initializing AR scene...
    </div>

    <script>
    // Define the debounce function before using it
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    (function() {
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed');
            const debugDiv = document.getElementById('debugDiv');
            const boxEl = document.querySelector('a-box');
            let hasReceivedGps = false;

            function updateDebugInfo(message) {
                debugDiv.innerHTML += `<br>${message}`;
            }

            boxEl.addEventListener('gps-entity-place-added', () => {
                updateDebugInfo('Box positioned based on GPS coordinates.');
            });

            const debouncedGPSUpdate = debounce((e) => {
                try {
                    const { latitude, longitude } = e.detail.position;
                    debugDiv.innerHTML = `Current GPS: lat ${latitude.toFixed(6)}, lon ${longitude.toFixed(6)}`;
                    
                    const distance = boxEl.getAttribute('distance');
                    if (distance !== null && distance !== undefined && !isNaN(distance)) {
                        updateDebugInfo(`Distance to box: ${parseFloat(distance).toFixed(2)} meters`);
                    } else {
                        updateDebugInfo('Distance to box: Not available yet');
                    }

                    if (!hasReceivedGps) {
                        hasReceivedGps = true;
                        updateDebugInfo('GPS signal acquired. Looking for AR markers...');
                    }
                } catch (error) {
                    console.error('Error in GPS update:', error);
                    updateDebugInfo(`Error in GPS update: ${error.message}`);
                }
            }, 200);

            window.addEventListener('gps-camera-update-position', debouncedGPSUpdate);

            // Error handling
            boxEl.addEventListener('error', (error) => {
                console.error('Box element error:', error);
                updateDebugInfo(`Box element error: ${error.detail.message || 'Unknown error'}`);
            });

            document.querySelector('a-scene').addEventListener('error', (error) => {
                console.error('A-Scene error:', error);
                updateDebugInfo(`A-Scene error: ${error.detail.message || 'Unknown error'}`);
            });

            // Check for geolocation support
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(() => {
                    updateDebugInfo('Geolocation permission granted.');
                }, (error) => {
                    updateDebugInfo(`Geolocation error: ${error.message}`);
                });
            } else {
                updateDebugInfo('Geolocation is not supported by this browser.');
            }
        });
    })();
    </script>
</body>
</html>
