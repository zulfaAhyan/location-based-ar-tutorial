<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>AR.js Waypoints Navigation</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>
  <style>
    .error-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 9999;
      text-align: center;
    }
    .loading-indicator {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 9999;
    }
    .debug-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 9999;
      font-family: monospace;
      max-width: 80vw;
      word-wrap: break-word;
    }
  </style>
  <script>
    AFRAME.registerComponent('waypoints-manager', {
      init: function () {
        this.showLoadingIndicator();
        this.showDebugInfo('Initializing...');
        
        // Add delay to ensure debug info is visible
        setTimeout(() => {
          this.checkPermissions()
            .then(() => {
              this.showDebugInfo('Permissions granted, loading waypoints...');
              return this.loadWaypoints();
            })
            .catch(error => {
              this.showDebugInfo('Error: ' + error);
              this.showError(error);
            });
        }, 1000);
      },

      showDebugInfo: function(message) {
        if (!this.debugElement) {
          this.debugElement = document.createElement('div');
          this.debugElement.className = 'debug-info';
          document.body.appendChild(this.debugElement);
        }
        this.debugElement.innerHTML += message + '<br>';
        console.log('Debug:', message);
      },

      checkPermissions: function() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject('GPS not supported by your browser');
            return;
          }

          this.showDebugInfo('Checking GPS...');
          navigator.geolocation.getCurrentPosition(
            (position) => {
              this.showDebugInfo(`GPS OK: ${position.coords.latitude}, ${position.coords.longitude}`);
              
              this.showDebugInfo('Checking camera...');
              navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                  stream.getTracks().forEach(track => track.stop());
                  this.showDebugInfo('Camera OK');
                  resolve();
                })
                .catch((err) => {
                  this.showDebugInfo('Camera Error: ' + err.message);
                  reject('Camera access denied: ' + err.message);
                });
            },
            (err) => {
              this.showDebugInfo('GPS Error: ' + err.message);
              reject('GPS access denied: ' + err.message);
            },
            { 
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0
            }
          );
        });
      },

      showLoadingIndicator: function() {
        const loading = document.createElement('div');
        loading.className = 'loading-indicator';
        loading.textContent = 'Loading waypoints...';
        document.body.appendChild(loading);
        this.loadingIndicator = loading;
      },

      hideLoadingIndicator: function() {
        if (this.loadingIndicator) {
          this.loadingIndicator.remove();
        }
      },

      showError: function(message) {
        const error = document.createElement('div');
        error.className = 'error-message';
        error.textContent = message;
        document.body.appendChild(error);
      },

      getRouteId: function () {
        const urlParams = new URLSearchParams(window.location.search);
        const routeId = urlParams.get('routeId');
        this.showDebugInfo(`Route ID: ${routeId}`);
        return routeId;
      },

      loadWaypoints: function () {
        const routeId = this.getRouteId();
        if (!routeId) {
          this.hideLoadingIndicator();
          this.showError('No routeId provided in URL');
          return;
        }

        const waypointsUrl = `https://waypoints-prht.onrender.com/get-waypoints/${routeId}`;
        this.showDebugInfo(`Fetching waypoints from: ${waypointsUrl}`);

        fetch(waypointsUrl)
          .then(response => {
            this.showDebugInfo(`Server response status: ${response.status}`);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(waypoints => {
            this.showDebugInfo(`Fetched ${waypoints.length} waypoints`);
            
            if (waypoints.length === 0) {
              this.showError('No waypoints found for this route');
              return;
            }

            waypoints.forEach((waypoint, index) => {
              if (!waypoint.lat || !waypoint.lng) {
                this.showDebugInfo(`Invalid coordinates for waypoint ${index + 1}`);
                return;
              }

              this.showDebugInfo(`Processing waypoint ${index + 1}: ${waypoint.lat}, ${waypoint.lng}`);

              const container = document.createElement('a-entity');
              container.setAttribute('gps-new-entity-place', {
                latitude: waypoint.lat,
                longitude: waypoint.lng
              });

              const box = document.createElement('a-box');
              box.setAttribute('color', this.getColorForIndex(index));
              box.setAttribute('scale', '0.5 0.5 0.5');
              box.setAttribute('position', '0 1 0');
              
              const text = document.createElement('a-text');
              text.setAttribute('value', `Waypoint ${index + 1}`);
              text.setAttribute('scale', '1 1 1');
              text.setAttribute('position', '0 1.5 0');
              text.setAttribute('align', 'center');
              text.setAttribute('color', 'white');
              
              container.appendChild(box);
              container.appendChild(text);
              this.el.sceneEl.appendChild(container);
            });

            this.hideLoadingIndicator();
            this.showDebugInfo('Finished loading waypoints');
          })
          .catch(error => {
            this.showDebugInfo('Error: ' + error.message);
            console.error('Error fetching waypoints:', error);
            this.hideLoadingIndicator();
            this.showError('Failed to load waypoints. Please try again.');
          });
      },

      getColorForIndex: function (index) {
        const colors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange'];
        return colors[index % colors.length];
      }
    });
  </script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: true; sourceWidth: 1280; sourceHeight: 960; displayWidth: 1280; displayHeight: 960;"
    waypoints-manager
  >
    <a-camera gps-new-camera="gpsMinDistance: 5; positionMinAccuracy: 10"></a-camera>
  </a-scene>
</body>
</html>
